name: Publish Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version tag (e.g., v0.12)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    runs-on: ${{ matrix.os }}

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 PyQt6-QScintilla paramiko cryptography pyserial mpremote pyinstaller telnetlib3 certifi

    - name: ğŸ§ Install Linux System Dependencies
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libxcb-cursor0 libgl1 libxkbcommon-x11-0

    - name: ğŸ“ Inject Version into GUI_pyqt.py
      shell: bash
      run: python -c "import re; f=open('GUI_pyqt.py', 'r', encoding='utf-8'); c=f.read(); f.close(); c=re.sub(r'CURRENT_VERSION\s*=\s*\".*?\"', 'CURRENT_VERSION = \"${{ inputs.version }}\"', c); f=open('GUI_pyqt.py', 'w', encoding='utf-8'); f.write(c); f.close()"

    - name: ğŸ—ï¸ Run Build Script
      env:
        PYTHONIOENCODING: utf8
      run: |
        python build_exe.py

    - name: ğŸ—œï¸ Strip Debug Symbols (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        find dist/ -name "OmniBoard Studio" -type f -executable -exec strip --strip-unneeded {} +

    - name: ğŸ“¦ Package Linux Build (tar.gz)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd "dist/OmniBoard Studio"
        tar -czf ../../OmniBoard_Studio_Linux.tar.gz *

    - name: ğŸ“¦ Package Windows Build (zip)
      if: matrix.os == 'windows-latest'
      working-directory: dist/OmniBoard Studio
      run: |
        7z a -tzip "..\..\OmniBoard_Studio_Windows.zip" *
    
    - name: ğŸ“ Inject Version into Installer Script
      if: matrix.os == 'windows-latest'
      shell: bash
      run: |
        sed -i 's/^AppVersion=.*/AppVersion=${{ inputs.version }}/' OmniBoard_Studio_Installer.iss

    - name: ğŸ› ï¸ Compile Windows Installer (Inno Setup)
      if: matrix.os == 'windows-latest'
      run: |
        choco install innosetup
        iscc OmniBoard_Studio_Installer.iss

    - name: ğŸš€ Publish to GitHub Release (Linux)
      if: matrix.os == 'ubuntu-latest'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ inputs.version }}
        name: OmniBoard Studio ${{ inputs.version }}
        draft: false
        prerelease: false
        files: |
          OmniBoard_Studio_Linux.tar.gz
          install.sh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸš€ Publish to GitHub Release (Windows)
      if: matrix.os == 'windows-latest'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ inputs.version }}
        name: OmniBoard Studio ${{ inputs.version }}
        draft: false
        prerelease: false
        files: |
          OmniBoard_Studio_Windows.zip
          OmniBoard_Online_Installer.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
